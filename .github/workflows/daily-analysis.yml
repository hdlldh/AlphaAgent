name: Daily Stock Analysis

# Run Monday-Friday at 10 PM UTC (after market close)
# Cron format: minute hour day-of-month month day-of-week
# 0 22 * * 1-5 = 10 PM UTC, Monday through Friday
on:
  schedule:
    - cron: '0 22 * * 1-5'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip delivery)'
        required: false
        type: boolean
        default: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing commits

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch the database file
          fetch-depth: 1
          # Persist credentials for pushing
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv pip install -e . --system

      - name: Run daily analysis
        env:
          # LLM Provider Configuration (use one)
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'anthropic' }}

          # Anthropic Claude API Key
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

          # OpenAI API Key (alternative)
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # Google Gemini API Key (alternative)
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

          # Stock Data API Keys
          STOCK_ANALYZER_STOCK_API_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}

          # Telegram Bot Token
          STOCK_ANALYZER_TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}

          # Database path
          STOCK_ANALYZER_DB_PATH: ./data/stock_analyzer.db
        run: |
          python src/scripts/daily_analysis.py

      - name: Commit database changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add database if it changed
          git add data/stock_analyzer.db

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update analysis database [skip ci]"
            git push
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Daily analysis job failed"
          # Could add Telegram notification here using curl
          # curl -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          #   -d "chat_id=${ADMIN_CHAT_ID}" \
          #   -d "text=‚ùå Daily analysis job failed. Check GitHub Actions logs."

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-logs
          path: |
            *.log
            data/stock_analyzer.db
          retention-days: 7
